.PHONY: help build run dev test clean swagger docker install

# Default target
help:
	@echo "Beenzer Server v3 - Makefile Commands"
	@echo ""
	@echo "  make install    - Install Go dependencies"
	@echo "  make build      - Build the server binary"
	@echo "  make run        - Build and run the server"
	@echo "  make dev        - Run in development mode (with hot reload if air is installed)"
	@echo "  make test       - Run tests"
	@echo "  make test-cover - Run tests with coverage"
	@echo "  make clean      - Remove build artifacts"
	@echo "  make swagger    - Generate Swagger documentation"
	@echo "  make fmt        - Format code"
	@echo "  make lint       - Run linter (requires golangci-lint)"
	@echo "  make tidy       - Tidy and verify go.mod"
	@echo "  make docker     - Build Docker image"
	@echo ""

# Install dependencies
install:
	@echo "ğŸ“¦ Installing dependencies..."
	go mod download
	go mod tidy

# Build binary
build:
	@echo "ğŸ”¨ Building server..."
	go build -o bin/beenzer-server cmd/server/main.go
	@echo "âœ… Build complete: bin/beenzer-server"

# Run the server
run: build
	@echo "ğŸš€ Starting server..."
	./bin/beenzer-server

# Development mode
dev:
	@echo "ğŸ”¥ Starting development server..."
	@if command -v air > /dev/null; then \
		air; \
	else \
		@echo "âš ï¸  'air' not found. Installing..."; \
		go install github.com/cosmtrek/air@latest; \
		air; \
	fi

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	go test -v ./...

# Run tests with coverage
test-cover:
	@echo "ğŸ§ª Running tests with coverage..."
	go test -v -cover -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "ğŸ“Š Coverage report: coverage.html"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning..."
	rm -rf bin/
	rm -f coverage.out coverage.html
	rm -rf docs/swagger.json docs/swagger.yaml
	@echo "âœ… Cleaned"

# Generate Swagger docs
swagger:
	@echo "ğŸ“š Generating Swagger documentation..."
	@if command -v swag > /dev/null; then \
		swag init -g cmd/server/main.go -o docs; \
		echo "âœ… Swagger docs generated in docs/"; \
	else \
		echo "âš ï¸  'swag' not found. Installing..."; \
		go install github.com/swaggo/swag/cmd/swag@latest; \
		swag init -g cmd/server/main.go -o docs; \
		echo "âœ… Swagger docs generated in docs/"; \
	fi

# Format code
fmt:
	@echo "âœ¨ Formatting code..."
	go fmt ./...
	@echo "âœ… Code formatted"

# Run linter
lint:
	@echo "ğŸ” Running linter..."
	@if command -v golangci-lint > /dev/null; then \
		golangci-lint run; \
	else \
		echo "âš ï¸  golangci-lint not found. Please install it."; \
		echo "    https://golangci-lint.run/usage/install/"; \
	fi

# Tidy go.mod
tidy:
	@echo "ğŸ§¹ Tidying go.mod..."
	go mod tidy
	go mod verify
	@echo "âœ… go.mod tidied"

# Build Docker image
docker:
	@echo "ğŸ³ Building Docker image..."
	docker build -t beenzer-server:v3 .
	@echo "âœ… Docker image built: beenzer-server:v3"

# Run with race detector
race:
	@echo "ğŸƒ Running with race detector..."
	go run -race cmd/server/main.go

# Quick development workflow
quick: fmt tidy test build
	@echo "âœ… Quick workflow complete!"
